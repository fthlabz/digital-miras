<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FthLabz | Dijital Miras</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        /* --- TEMEL AYARLAR --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body {
            background-color: #000; color: #fff; font-family: 'Inter', sans-serif; 
            margin: 0; padding: 0; 
            width: 100%; height: 100%; /* Tam ekranÄ± kapsa */
            overflow: hidden; /* Ana sayfa kaymasÄ±n, sadece iÃ§erik kaysÄ±n */
        }

        /* --- ANA MENÃœ KAYDIRMA ALANI --- */
        .scroll-wrapper {
            width: 100%; height: 100%;
            overflow-y: auto; /* AÅŸaÄŸÄ± yukarÄ± kaydÄ±rma serbest */
            overflow-x: hidden; /* SaÄŸa sola taÅŸma yasak */
            -webkit-overflow-scrolling: touch; /* iPhone'da yaÄŸ gibi aksÄ±n */
        }

        .container { 
            max-width: 480px; margin: 0 auto; 
            padding: 20px; 
            display: flex; flex-direction: column;
            min-height: 100%;
        }
        
        .header { text-align: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #222; }
        .header h1 { color: #D4AF37; margin: 0; font-family: 'Playfair Display', serif; font-size: 32px; letter-spacing: 1px; }
        .slogan { color: #888; font-size: 11px; font-style: italic; margin-top: 5px; }
        
        #loading { text-align: center; margin-top: 100px; color: #D4AF37; font-size: 14px; animation: pulse 2s infinite; }
        .panel { display: none; animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .gold-card { border: 1px solid #333; background: linear-gradient(145deg, #111, #0a0a0a); padding: 25px; border-radius: 16px; text-align: center; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .user-title { color: #D4AF37; font-family: 'Playfair Display', serif; font-size: 22px; line-height: 1.4; }

        .menu-btn { display: flex; align-items: center; gap: 20px; background: #111; border: 1px solid #222; padding: 20px; margin-bottom: 15px; border-radius: 16px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
        .menu-btn:active { transform: scale(0.98); background: #1a1a1a; border-color: #D4AF37; }
        .menu-icon { color: #D4AF37; font-size: 24px; width: 40px; text-align: center; }
        .menu-text h3 { margin: 0; font-size: 16px; color: #fff; font-weight: 600; }
        .menu-text p { margin: 4px 0 0; font-size: 11px; color: #666; }
        .menu-arrow { margin-left: auto; color: #333; }

        label { display: block; color: #D4AF37; font-size: 10px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; margin-top: 20px;}
        input, textarea { width: 100%; background: #0a0a0a; border: 1px solid #333; color: #fff; padding: 16px; border-radius: 12px; box-sizing: border-box; font-family: inherit; font-size: 14px; }
        input:focus, textarea:focus { border-color: #D4AF37; outline: none; background: #050505; }
        .main-btn { width: 100%; background: #D4AF37; color: #000; padding: 18px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 30px; font-size: 14px; letter-spacing: 1px; }

        /* KILAVUZ KUTUSU */
        .guide-box { background: #151515; border: 1px solid #333; padding: 15px; border-radius: 12px; margin-bottom: 20px; font-size: 12px; color: #ccc; line-height: 1.6; }
        .guide-title { color: #D4AF37; font-weight: bold; font-size: 14px; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; display: block; }
        .guide-step { margin-bottom: 8px; padding-left: 10px; border-left: 2px solid #444; }
        .guide-sub { font-size: 11px; color: #888; margin-top: 2px; }

        /* --- MODAL (GÃ–RÃœNTÃœLEYÄ°CÄ° - Ã‡Ã–ZÃœM BURADA) --- */
        #viewer-modal {
            position: fixed; inset: 0; background: #000; z-index: 9999; 
            display: none; 
            flex-direction: column; /* Alt alta diz */
            width: 100%; height: 100%;
        }

        .viewer-header {
            height: 60px; 
            flex-shrink: 0; /* Asla kÃ¼Ã§Ã¼lme, hep sabit kal */
            border-bottom: 1px solid #222; 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 15px; background: #050505;
            z-index: 100; /* Her ÅŸeyin Ã¼stÃ¼nde */
        }
        
        .close-viewer { 
            color: #fff; font-size: 15px; font-weight: 500; cursor: pointer; 
            display: flex; align-items: center; gap: 8px; padding: 10px; 
            background: rgba(255,255,255,0.05); border-radius: 8px; /* Buton belirgin olsun */
        }
        .close-viewer i { color: #D4AF37; font-size: 18px; }
        .viewer-title { color: #D4AF37; font-family: 'Playfair Display', serif; font-size: 18px; letter-spacing: 0.5px; }
        
        .iframe-container { 
            flex-grow: 1; /* Kalan tÃ¼m alanÄ± kapla */
            width: 100%; 
            background: #000; 
            overflow-y: auto; /* Ä°Ã‡ERÄ°K KAYAR, HEADER SABÄ°T KALIR */
            -webkit-overflow-scrolling: touch;
            position: relative;
        }

        /* Iframe'e dokunma yasaÄŸÄ±nÄ± kaldÄ±rdÄ±k - SWIPE ARTIK Ã‡ALIÅžIR */
        .drive-embed { border: none; width: 100%; height: 100%; display: block; }

        .loading-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #D4AF37; font-family: 'Playfair Display', serif; font-size: 14px; letter-spacing: 3px;
            text-transform: uppercase; text-align: center; width: 100%; z-index: 10;
            display: none; animation: pulseText 2s infinite ease-in-out;
        }
        @keyframes pulseText {
            0% { opacity: 0.3; transform: translate(-50%, -50%) scale(0.95); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0.3; transform: translate(-50%, -50%) scale(0.95); }
        }

        #password-screen { text-align: center; padding-top: 50px; }
        .lock-icon { font-size: 40px; color: #D4AF37; margin-bottom: 20px; }
    </style>
</head>
<body onclick="resetTimer()" onmousemove="resetTimer()" onkeypress="resetTimer()" ontouchstart="resetTimer()">

<div class="scroll-wrapper">
    <div class="container">
        <div class="header"><h1>FthLabz</h1><p class="slogan">"GeÃ§miÅŸten geleceÄŸe bÄ±rakÄ±lan en deÄŸerli miras..."</p></div>
        
        <div id="loading">SÄ°STEM HAZIRLANIYOR...</div>

        <div id="password-screen" class="panel">
            <div class="lock-icon"><i class="fas fa-lock"></i></div>
            <p style="color:#888; font-size:13px; margin-bottom:20px;">Bu albÃ¼m ÅŸifrelenmiÅŸtir.</p>
            <input type="password" id="unlockPass" placeholder="Åžifreniz..." style="text-align:center; font-size:18px; letter-spacing: 3px;">
            <button class="main-btn" onclick="unlockAlbum()">GÄ°RÄ°Åž YAP</button>
        </div>

        <div id="setup-panel" class="panel">
            <div class="gold-card"><h2 class="user-title">AlbÃ¼m Kurulumu</h2><p style="font-size:11px; color:#888;">LÃ¼tfen aÅŸaÄŸÄ±daki adÄ±mlarÄ± takip edin.</p></div>
            
            <div class="guide-box">
                <span class="guide-title">1. DRIVE HESABI VE KLASÃ–RLER</span>
                <div class="guide-step">Google Drive uygulamasÄ±nÄ± aÃ§Ä±n.</div>
                <div class="guide-step">3 tane KlasÃ¶r oluÅŸturun:
                    <br><span style="color:#D4AF37">Videolar</span>, <span style="color:#D4AF37">Resimler</span>, <span style="color:#D4AF37">Sesler</span>
                </div>
            </div>

            <div class="guide-box">
                <span class="guide-title">2. RESÄ°M YÃœKLEME (KOLAY YOL)</span>
                <div class="guide-step">Telefon Galerinizi aÃ§Ä±n, resimleri seÃ§in.</div>
                <div class="guide-step">Drive uygulamasÄ±na sÃ¼rÃ¼kleyip ilgili klasÃ¶re bÄ±rakÄ±n.</div>
                <div class="guide-step">Veya Drive iÃ§inde (+) butonuna basÄ±p "YÃ¼kle" deyin.</div>
            </div>

            <div class="guide-box">
                <span class="guide-title">3. LÄ°NKLERÄ° ALMA (Ã‡OK Ã–NEMLÄ°)</span>
                <div class="guide-step">KlasÃ¶rÃ¼n yanÄ±ndaki 3 noktaya (...) tÄ±klayÄ±n.</div>
                <div class="guide-step">"EriÅŸimi YÃ¶net" veya "PaylaÅŸ" deyin.</div>
                <div class="guide-step">"KÄ±sÄ±tlÄ±" yazan yeri <b>"BaÄŸlantÄ±ya sahip herkes"</b> yapÄ±n.</div>
                <div class="guide-step">Link simgesine basÄ±p kopyalayÄ±n.</div>
            </div>

            <label>1. ALBÃœM BAÅžLIÄžI</label><input type="text" id="inTitle" placeholder="Ã–rn: CanÄ±m Ailem">
            <label>2. ANI DEFTERÄ°M</label><textarea id="inNot" rows="4" placeholder="AnÄ±larÄ±nÄ±zÄ± buraya yazÄ±n..."></textarea>
            <label>3. SESLÄ° MESAJ LÄ°NKÄ° (OPSÄ°YONEL)</label><input type="text" id="inSes" placeholder="Drive dosya linki">
            
            <div style="border-top: 1px dashed #333; margin-top: 25px; padding-top:10px;">
                <label style="color:#fff;">4. KLASÃ–R LÄ°NKLERÄ° (ZORUNLU)</label>
                <input type="text" id="inVideoLink" placeholder="VÄ°DEOLAR KlasÃ¶r Linki" style="margin-bottom:10px;">
                <input type="text" id="inPhotoLink" placeholder="RESÄ°MLER KlasÃ¶r Linki" style="margin-bottom:10px;">
                <input type="text" id="inSoundLink" placeholder="SESLER KlasÃ¶r Linki">
            </div>
            
            <label style="color:#D4AF37; margin-top:20px;">YÃ–NETÄ°CÄ° ÅžÄ°FRESÄ° BELÄ°RLEYÄ°N</label>
            <input type="password" id="inPass" placeholder="Åžifrenizi Girin">
            <input type="password" id="inPassConfirm" placeholder="Åžifreyi Tekrar Girin (DoÄŸrulama)" style="margin-top:10px; border-color:#555;">
            
            <button class="main-btn" onclick="saveData()">ÅžÄ°FRELE VE KAYDET</button><br><br>
        </div>

        <div id="view-panel" class="panel">
            <div class="gold-card"><h2 id="displayTitle" class="user-title">...</h2></div>
            <div class="menu-btn" onclick="openTextModal()"><div class="menu-icon"><i class="fas fa-book"></i></div><div class="menu-text"><h3>AnÄ± Defterim</h3><p>Okumak iÃ§in dokun</p></div><div class="menu-arrow"><i class="fas fa-chevron-right"></i></div></div>
            <div id="btnSes" class="menu-btn" onclick="openAudioPlayer()"><div class="menu-icon"><i class="fas fa-microphone"></i></div><div class="menu-text"><h3>GÃ¼nlÃ¼k Sesli Mesaj</h3><p>Dinlemek iÃ§in dokun</p></div><div class="menu-arrow"><i class="fas fa-play"></i></div></div>
            <div id="btnVideo" class="menu-btn" onclick="openDriveViewer('video')"><div class="menu-icon"><i class="fas fa-video"></i></div><div class="menu-text"><h3>Dijital AlbÃ¼m Videolar</h3><p>Ä°zlemek iÃ§in dokun</p></div><div class="menu-arrow"><i class="fas fa-chevron-right"></i></div></div>
            <div id="btnPhoto" class="menu-btn" onclick="openDriveViewer('photo')"><div class="menu-icon"><i class="fas fa-images"></i></div><div class="menu-text"><h3>Dijital AlbÃ¼m Resimler</h3><p>GÃ¶rÃ¼ntÃ¼lemek iÃ§in dokun</p></div><div class="menu-arrow"><i class="fas fa-chevron-right"></i></div></div>
            <div id="btnSound" class="menu-btn" onclick="openDriveViewer('sound')"><div class="menu-icon"><i class="fas fa-music"></i></div><div class="menu-text"><h3>Dijital AlbÃ¼m Sesler</h3><p>ArÅŸivi dinlemek iÃ§in dokun</p></div><div class="menu-arrow"><i class="fas fa-chevron-right"></i></div></div>
            <div style="text-align:center; margin-top:20px; opacity:0.3; font-size:10px;"><span onclick="enableEdit()">DÃ¼zenle</span></div>
        </div>
    </div>
</div>

<div id="viewer-modal">
    <div class="viewer-header">
        <div class="close-viewer" onclick="closeViewer()"><i class="fas fa-chevron-left"></i> <span>Geri DÃ¶n</span></div>
        <span class="viewer-title" id="viewer-title-text">AlbÃ¼m</span>
    </div>
    <div class="iframe-container">
        <div class="loading-text">ANILARINIZ<br>HAZIRLANIYOR...</div>
        <iframe id="drive-frame" class="drive-embed" src="" allow="autoplay; fullscreen" onload="frameLoaded()"></iframe>
        <div id="text-content" style="padding:30px; color:#ddd; font-size:16px; line-height:1.6; display:none; overflow-y:auto;"></div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbypgMb5URFmLu5aHqqOACygD3jk4jj9ZygbkKXvLlVHrncHSkC-T74DBV6g5JNstX9bUA/exec"; 
    const urlParams = new URLSearchParams(window.location.search);
    const currentID = urlParams.get('id');
    let pageData = {}, encryptedData = {};
    
    // --- GÃœVENLÄ°K SAYACI (1 SAAT = 3600000 ms) ---
    let inactivityTimer;
    const TIMEOUT_DURATION = 3600000; 

    function resetTimer() {
        clearTimeout(inactivityTimer);
        if(document.getElementById('view-panel').style.display === 'block') {
            inactivityTimer = setTimeout(lockScreen, TIMEOUT_DURATION);
        }
    }

    function lockScreen() {
        pageData = {};
        document.getElementById('displayTitle').innerText = "...";
        document.getElementById('unlockPass').value = "";
        document.getElementById('view-panel').style.display = 'none';
        closeViewer(); 
        document.getElementById('password-screen').style.display = 'block';
        alert("ðŸ”’ GÃ¼venlik: 1 saat iÅŸlem yapÄ±lmadÄ±ÄŸÄ± iÃ§in oturum kilitlendi.");
    }

    window.onload = function() { if (!currentID) { document.getElementById('loading').innerHTML = "ID BulunamadÄ± (Ã–rn: ?id=1001)"; return; } fetchData(); };
    function fetchData() { fetch(API_URL + "?action=read&id=" + currentID).then(res => res.json()).then(data => { document.getElementById('loading').style.display = 'none'; if (data.status === "empty") { document.getElementById('setup-panel').style.display = 'block'; } else { encryptedData = data; document.getElementById('password-screen').style.display = 'block'; } }).catch(err => alert("Veri Ã§ekilemedi.")); }
    
    function unlockAlbum() { 
        const pass = document.getElementById('unlockPass').value; 
        if(!pass) return alert("Åžifre giriniz."); 
        try { 
            const title = CryptoJS.AES.decrypt(encryptedData.title, pass).toString(CryptoJS.enc.Utf8); 
            if(!title) throw "HatalÄ± Åžifre"; 
            const not = CryptoJS.AES.decrypt(encryptedData.not, pass).toString(CryptoJS.enc.Utf8); 
            const combinedBytes = CryptoJS.AES.decrypt(encryptedData.folder, pass).toString(CryptoJS.enc.Utf8); 
            const folders = combinedBytes.split('|||'); 
            let ses = ""; 
            if(encryptedData.ses) { ses = CryptoJS.AES.decrypt(encryptedData.ses, pass).toString(CryptoJS.enc.Utf8); } 
            pageData = { title: title, not: not, ses: ses, videoFolder: folders[0], photoFolder: folders[1], soundFolder: folders[2], pass: pass }; 
            
            document.getElementById('displayTitle').innerText = title; 
            if(!ses) document.getElementById('btnSes').style.display = 'none'; 
            if(!folders[0]) document.getElementById('btnVideo').style.display = 'none'; 
            if(!folders[1]) document.getElementById('btnPhoto').style.display = 'none'; 
            if(!folders[2]) document.getElementById('btnSound').style.display = 'none'; 
            
            document.getElementById('password-screen').style.display = 'none'; 
            document.getElementById('view-panel').style.display = 'block'; 
            
            resetTimer(); 
        } catch(e) { alert("HatalÄ± Åžifre!"); } 
    }
    
    function getFolderId(url) { const match = url.match(/folders\/([-a-zA-Z0-9_]+)/); return match ? match[1] : null; }
    
    function frameLoaded() {
        const textLoader = document.querySelector('.loading-text');
        const iframe = document.getElementById('drive-frame');
        textLoader.style.display = 'none'; iframe.style.opacity = '1'; 
    }

    function openDriveViewer(type) { 
        let link = "", title = ""; 
        if(type === 'video') { link = pageData.videoFolder; title = "Videolar"; } 
        if(type === 'photo') { link = pageData.photoFolder; title = "Resimler"; } 
        if(type === 'sound') { link = pageData.soundFolder; title = "Ses ArÅŸivi"; } 
        
        const folderId = getFolderId(link); 
        const modal = document.getElementById('viewer-modal');
        const iframe = document.getElementById('drive-frame');
        const textLoader = document.querySelector('.loading-text');

        if(folderId) { 
            const embedUrl = `https://drive.google.com/embeddedfolderview?id=${folderId}#grid`; 
            document.getElementById('viewer-title-text').innerText = title; 
            document.getElementById('text-content').style.display = 'none'; 
            iframe.style.opacity = '0'; iframe.style.display = 'block'; textLoader.style.display = 'block'; 
            iframe.src = embedUrl; 
            modal.style.display = 'flex';
            setTimeout(() => { frameLoaded(); }, 4000); 
        } else { window.open(link, '_blank'); } 
    }
    
    function openTextModal() { 
        const modal = document.getElementById('viewer-modal');
        const iframe = document.getElementById('drive-frame');
        const textLoader = document.querySelector('.loading-text');
        iframe.style.display = 'none'; textLoader.style.display = 'none';
        const txt = document.getElementById('text-content'); 
        txt.innerText = pageData.not; txt.style.display = 'block'; 
        document.getElementById('viewer-title-text').innerText = "AnÄ± Defteri"; 
        modal.style.display = 'flex'; 
    }
    
    function openAudioPlayer() { 
        const fileIdMatch = pageData.ses.match(/\/d\/([-a-zA-Z0-9_]+)/); 
        if(fileIdMatch) { 
            const previewLink = `https://drive.google.com/file/d/${fileIdMatch[1]}/preview`; 
            const modal = document.getElementById('viewer-modal');
            const iframe = document.getElementById('drive-frame');
            const textLoader = document.querySelector('.loading-text');
            document.getElementById('viewer-title-text').innerText = "Sesli Mesaj"; 
            document.getElementById('text-content').style.display = 'none'; 
            iframe.style.opacity = '0'; iframe.style.display = 'block'; textLoader.style.display = 'block';
            iframe.src = previewLink; 
            modal.style.display = 'flex'; 
            setTimeout(() => { frameLoaded(); }, 4000);
        } else { window.open(pageData.ses, '_blank'); } 
    }
    
    function closeViewer() { 
        const modal = document.getElementById('viewer-modal');
        modal.style.display = 'none'; 
        document.getElementById('drive-frame').src = ""; 
    }
    
    function saveData() { 
        const pass = document.getElementById('inPass').value; 
        const passConfirm = document.getElementById('inPassConfirm').value;
        if(!pass) { alert("LÃ¼tfen ÅŸifre belirleyin!"); return; }
        if(pass !== passConfirm) { alert("âš ï¸ HATA: GirdiÄŸiniz ÅŸifreler birbirini tutmuyor!"); return; }

        const v = document.getElementById('inVideoLink').value.trim(); 
        const p = document.getElementById('inPhotoLink').value.trim(); 
        const s = document.getElementById('inSoundLink').value.trim(); 
        const combinedFolder = `${v}|||${p}|||${s}`; 
        
        const btn = document.querySelector('.main-btn'); btn.innerText = "KAYDEDÄ°LÄ°YOR..."; btn.disabled = true; 
        const encTitle = CryptoJS.AES.encrypt(document.getElementById('inTitle').value, pass).toString(); 
        const encNot = CryptoJS.AES.encrypt(document.getElementById('inNot').value, pass).toString(); 
        const encSes = CryptoJS.AES.encrypt(document.getElementById('inSes').value, pass).toString(); 
        const encFolder = CryptoJS.AES.encrypt(combinedFolder, pass).toString(); 
        
        const query = `?action=save&id=${currentID}&password=encrypted&title=${encodeURIComponent(encTitle)}&not=${encodeURIComponent(encNot)}&folder=${encodeURIComponent(encFolder)}&ses=${encodeURIComponent(encSes)}`; 
        fetch(API_URL + query).then(res => res.json()).then(data => { 
            if(data.status === "success") { alert("âœ… Kurulum BaÅŸarÄ±lÄ±!"); location.reload(); } 
            else { alert("Hata!"); btn.disabled = false; } 
        }); 
    }
    
    function enableEdit() { 
        if(confirm("Yeniden dÃ¼zenlemek istiyor musunuz?")) { 
            document.getElementById('view-panel').style.display = 'none'; 
            document.getElementById('setup-panel').style.display = 'block'; 
            document.getElementById('inTitle').value = pageData.title; 
            document.getElementById('inNot').value = pageData.not; 
            document.getElementById('inSes').value = pageData.ses; 
            document.getElementById('inVideoLink').value = pageData.videoFolder; 
            document.getElementById('inPhotoLink').value = pageData.photoFolder; 
            document.getElementById('inSoundLink').value = pageData.soundFolder; 
            document.getElementById('inPass').value = pageData.pass; 
            document.getElementById('inPassConfirm').value = pageData.pass; 
        } 
    }
</script>
</body>
</html>
